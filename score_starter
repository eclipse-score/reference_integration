#!/usr/bin/env python3
import os
import sys
import termios
import tty
import subprocess
import argparse

# ================== CONFIG ==================
# Each entry: (description, command, name)
mEntries = [
    ("Run QNX x86_64 QEMU", "bazel --output_base=build/qnx-x86_64 run --config qnx-x86_64  //images/qnx_x86_64:run", "qnx-x86_64"),
    ("Run Linux x86_64 Docker", "bazel --output_base=build/linux-x86_64 run --config linux-x86_64  //images/linux_x86_64:run", "linux-x86_64"),
    ("Run Elektrobit corbos Linux for Safety Applications aarch64 QEMU",
     "bazel --output_base=build/eb-aarch64 run --config eb-aarch64  //images/ebclfsa_aarch64:run", "eb-aarch64"),
    ("Run Autosd x86_64 QEMU",
     "bazel --output_base=build/autosd-x86_64 run --config autosd-x86_64  //images/autosd_x86_64:run", "autosd-x86_64"),
    ("Exit", "exit 0", "exit"),
]

# ================== INTERNAL ==================
mSelected = 0
mCount = len(mEntries)


def clear():
    os.system("clear")


def draw_menu():
    clear()
    print("Use ↑ ↓ to navigate, Enter to run, q to quit\n")
    for i, (desc, _, _) in enumerate(mEntries):
        if i == mSelected:
            # inverse video
            print(f"  \033[7m {desc} \033[0m")
        else:
            print(f"    {desc}")


def run_entry(entry):
    desc, cmd, _ = entry
    clear()
    print(f"▶ {desc}\n")

    if cmd.startswith("exit"):
        sys.exit(0)

    # Run command in user's shell
    print("Running ", cmd)
    result = subprocess.call(cmd, shell=True)
    sys.exit(result)


def read_key():
    fd = sys.stdin.fileno()
    old = termios.tcgetattr(fd)
    try:
        tty.setraw(fd)
        ch1 = sys.stdin.read(1)
        if ch1 == "\x1b":
            ch2 = sys.stdin.read(1)
            ch3 = sys.stdin.read(1)
            return ch1 + ch2 + ch3
        return ch1
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old)


def interactive_loop():
    global mSelected
    while True:
        draw_menu()
        key = read_key()

        if key == "\x1b[A":        # Up
            mSelected = (mSelected - 1) % mCount
        elif key == "\x1b[B":      # Down
            mSelected = (mSelected + 1) % mCount
        elif key in ("\r", "\n"):  # Enter
            run_entry(mEntries[mSelected])
        elif key == "q":
            sys.exit(0)


# ================== MAIN ==================
def main():
    parser = argparse.ArgumentParser(
        description="Interactive build/run menu script",
        epilog="Use -r NAME to run a specific entry directly."
    )
    parser.add_argument(
        "-r", "--run",
        help="Run a specific menu entry by name",
        choices=[name for _, _, name in mEntries]
    )

    args = parser.parse_args()

    if args.run:
        # Find the entry by name and run it
        entry = next((e for e in mEntries if e[2] == args.run), None)
        if entry is None:
            print(f"Unknown entry: {args.run}")
            sys.exit(1)
        run_entry(entry)
    else:
        interactive_loop()


if __name__ == "__main__":
    main()
