# Module Integration Build Workflow
#
# Summary:
#   Builds all modules referenced in known_good.json with Bazel and runs the
#   integration test script to validate module interoperability.
#
# What it does:
#   - Checks out the reference integration repository
#   - Updates score_modules.MODULE.bazel from the provided known_good.json
#   - Builds all referenced modules (via scripts/integration_test.py and Bazel)
#   - Runs integration tests
#   - Uploads logs from _logs/ as artifact: bazel-build-logs-${{ inputs.config }}
#
# Inputs:
#   - known_good (string, required): JSON content used to pin module SHAs.
#   - config (string, optional, default: bl-x86_64-linux): Bazel config passed to
#     scripts/integration_test.py.
#   - repo_runner_labels (string, optional): Runner label(s). Accepts either a
#     single label string (e.g., ubuntu-latest) or a JSON string representing a
#     label or an array of labels (e.g., "\"ubuntu-latest\"" or
#     "[\"self-hosted\",\"linux\",\"x64\"]").
#   - target_branch (string, optional, default: main): Ref/branch to checkout.
#
# Repository Variables:
#   - REFERENCE_INTEGRATION_REPO (optional): Repository to checkout (owner/repo).
#     Default: eclipse-score/reference_integration
#
# Secrets:
#   - REPO_READ_TOKEN (secret, optional): Token for private module access; falls
#     back to github.token when not provided.
#
# Runner selection:
#   - Priority: `inputs.repo_runner_labels` > 'ubuntu-latest'.
#   - `repo_runner_labels` can be provided as a single label string or as JSON
#     (string or array). When JSON is used, it is parsed via fromJSON().
#
# Usage:
#   This workflow is reusable and triggered via workflow_call from other workflows.
#   Example:
#     jobs:
#       integration:
#         uses: eclipse-score/reference_integration/.github/workflows/module-integration-build.yml@main
#         with:
#           known_good: |
#             { "modules": [] }
#           config: bl-x86_64-linux
#           repo_runner_labels: 'ubuntu-latest'
#         secrets:
#           REPO_READ_TOKEN: ${{ secrets.REPO_READ_TOKEN }}
#
name: Module Integration Build

on:
  workflow_call:
    secrets:
      REPO_READ_TOKEN:
        description: 'GitHub token with read access to the score modules. Defaults to github.token'
        required: false
      SCORE_QNX_LICENSE:
        description: 'Base64-encoded QNX license file for QNX builds.'
        required: false
      SCORE_QNX_USER:
        description: 'Username for QNX license server authentication.'
        required: false
      SCORE_QNX_PASSWORD:
        description: 'Password for QNX license server authentication.'
        required: false
    inputs:
      known_good:
        description: 'Content of the known_good.json file to use for the integration test.'
        required: true
        type: string
      config:
        description: 'Optional configuration for the integration test.'
        required: false
        type: string
        default: 'x86_64-linux'
      repo_runner_labels:
        description: 'Runner label(s) for the job; single label or JSON string/array.'
        required: false
        type: string
      target_branch:
        description: 'Reference Integration repository ref to checkout.'
        required: false
        type: string
        default: 'main'

env:
  REFERENCE_INTEGRATION_REPO: ${{ vars.REFERENCE_INTEGRATION_REPO != '' && vars.REFERENCE_INTEGRATION_REPO || 'eclipse-score/reference_integration' }}

jobs:
  integration-test:
    name: Integration Test ${{ inputs.config }}
    runs-on: ${{ inputs.repo_runner_labels != '' && (startsWith(inputs.repo_runner_labels, '[') && fromJSON(inputs.repo_runner_labels) || inputs.repo_runner_labels) || 'ubuntu-latest' }}
    steps:
      - name: Clean disk space
        uses: eclipse-score/more-disk-space@v1

      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          repository: ${{ env.REFERENCE_INTEGRATION_REPO }}
          ref: ${{ inputs.target_branch || 'main' }}
          token: ${{ secrets.REPO_READ_TOKEN != '' && secrets.REPO_READ_TOKEN || github.token }}
      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.15.0
        with:
          # Avoid downloading Bazel every time.
          bazelisk-cache: true
          # Store build cache per workflow.
          disk-cache: ${{ inputs.config }}
          # Share repository cache between workflows.
          repository-cache: true
      - name: Prepare QNX license
        if: inputs.config == 'arm64-qnx8_0' || inputs.config == 'x86_64-qnx8_0'
        env:
          SCORE_QNX_LICENSE: ${{ secrets.SCORE_QNX_LICENSE }}
          SCORE_QNX_USER: ${{ secrets.SCORE_QNX_USER }}
          SCORE_QNX_PASSWORD: ${{ secrets.SCORE_QNX_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${SCORE_QNX_LICENSE}" ]; then
            echo "SCORE_QNX_LICENSE secret is not set. QNX builds will fail without a valid license."
            exit 1
          fi
          if [ -z "${SCORE_QNX_USER}" ]; then
            echo "SCORE_QNX_USER secret is not set. QNX builds will fail without authentication."
            exit 1
          fi
          if [ -z "${SCORE_QNX_PASSWORD}" ]; then
            echo "SCORE_QNX_PASSWORD secret is not set. QNX builds will fail without authentication."
            exit 1
          fi

          LICENSE_DIR="/opt/score_qnx/license"
          sudo mkdir -p "${LICENSE_DIR}"
          echo "${SCORE_QNX_LICENSE}" | base64 --decode | sudo tee "${LICENSE_DIR}/licenses" >/dev/null
      - name: Update known good commits
        run: |
          echo "::group::write known_good.json from input"
          # write the known_good.json from input
          cat > known_good.updated.json <<'EOF'
          ${{ inputs.known_good }}
          EOF
          cat known_good.updated.json
          echo "::endgroup::"
          
          echo "::group::update score_modules.MODULE.bazel"
          python3 scripts/known_good/update_module_from_known_good.py --known known_good.updated.json
          cat score_modules.MODULE.bazel
          echo "::endgroup::"
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_READ_TOKEN != '' && secrets.REPO_READ_TOKEN || github.token }}
      - name: Bazel build targets
        run: |
          python3 scripts/integration_test.py --known-good known_good.updated.json --config "${{ inputs.config }}"
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_READ_TOKEN != '' && secrets.REPO_READ_TOKEN || github.token }}
          SCORE_QNX_USER: ${{ secrets.SCORE_QNX_USER }}
          SCORE_QNX_PASSWORD: ${{ secrets.SCORE_QNX_PASSWORD }}
      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bazel-build-logs-${{ inputs.config }}
          path: _logs/
          if-no-files-found: warn
          retention-days: 14
