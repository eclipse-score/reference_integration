# Module Integration Build Workflow
#
# Summary:
#   Builds all modules referenced in known_good.json with Bazel and runs the
#   integration test script to validate module interoperability.
#
# What it does:
#   - Checks out the reference integration repository
#   - Updates score_modules.MODULE.bazel from the provided known_good.json
#   - Builds all referenced modules (via scripts/integration_test.sh and Bazel)
#   - Runs integration tests
#   - Uploads logs from _logs/ as artifact: bazel-build-logs-${{ inputs.config }}
#
# Inputs:
#   - known_good (string, required): JSON content used to pin module SHAs.
#   - config (string, optional, default: bl-x86_64-linux): Bazel config passed as
#     CONFIG to scripts/integration_test.sh.
#   - repo_runner_labels (string, optional): Runner label(s). Accepts either a
#     single label string (e.g., ubuntu-latest) or a JSON string representing a
#     label or an array of labels (e.g., "\"ubuntu-latest\"" or
#     "[\"self-hosted\",\"linux\",\"x64\"]").
#   - target_branch (string, optional, default: main): Ref/branch to checkout.
#
# Repository Variables:
#   - reference_integration_repo (optional): Repository to checkout (owner/repo).
#     Default: eclipse-score/reference_integration
#
# Secrets:
#   - REPO_READ_TOKEN (secret, optional): Token for private module access; falls
#     back to github.token when not provided.
#
# Runner selection:
#   - Priority: `inputs.repo_runner_labels` > 'ubuntu-latest'.
#   - `repo_runner_labels` can be provided as a single label string or as JSON
#     (string or array). When JSON is used, it is parsed via fromJSON().
#
# Usage:
#   This workflow is reusable and triggered via workflow_call from other workflows.
#   Example:
#     jobs:
#       integration:
#         uses: eclipse-score/reference_integration/.github/workflows/module-integration-build.yml@main
#         with:
#           known_good: |
#             { "modules": [] }
#           config: bl-x86_64-linux
#           repo_runner_labels: 'ubuntu-latest'
#         secrets:
#           REPO_READ_TOKEN: ${{ secrets.REPO_READ_TOKEN }}
#
name: Module Integration Build

on:
  workflow_call:
    secrets:
      REPO_READ_TOKEN:
        description: 'GitHub token with read access to the score modules. Defaults to github.token'
        required: false
    inputs:
      known_good:
        description: 'Content of the known_good.json file to use for the integration test.'
        required: true
        type: string
      config:
        description: 'Optional configuration for the integration test.'
        required: false
        type: string
        default: 'bl-x86_64-linux'
      repo_runner_labels:
        description: 'Runner label(s) for the job; single label or JSON string/array.'
        required: false
        type: string
      target_branch:
        description: 'Reference Integration repository ref to checkout.'
        required: false
        type: string
        default: 'main'

env:
  REFERENCE_INTEGRATION_REPO: ${{ vars.reference_integration_repo != '' && vars.reference_integration_repo || 'eclipse-score/reference_integration' }}

jobs:
  integration-test:
    name: Integration Test
    runs-on: ${{ inputs.repo_runner_labels != '' && (startsWith(inputs.repo_runner_labels, '[') && fromJSON(inputs.repo_runner_labels) || inputs.repo_runner_labels) || 'ubuntu-latest' }}
    steps:
      - name: Show disk space before build
        run: |
          echo 'Disk space before build:'
          df -h
      - name: Removing unneeded software
        run: |
          echo "Removing unneeded software... "
          if [ -d /usr/share/dotnet ]; then echo "Removing dotnet..."; start=$(date +%s); sudo rm -rf /usr/share/dotnet; end=$(date +%s); echo "Duration: $((end-start))s"; fi
          #if [ -d /usr/local/lib/android ]; then echo "Removing android..."; start=$(date +%s); sudo rm -rf /usr/local/lib/android; end=$(date +%s); echo "Duration: $((end-start))s"; fi
          if [ -d /opt/ghc ]; then echo "Removing haskell (ghc)..."; start=$(date +%s); sudo rm -rf /opt/ghc; end=$(date +%s); echo "Duration: $((end-start))s"; fi
          if [ -d /usr/local/.ghcup ]; then echo "Removing haskell (ghcup)..."; start=$(date +%s); sudo rm -rf /usr/local/.ghcup; end=$(date +%s); echo "Duration: $((end-start))s"; fi
          if [ -d /usr/share/swift ]; then echo "Removing swift..."; start=$(date +%s); sudo rm -rf /usr/share/swift; end=$(date +%s); echo "Duration: $((end-start))s"; fi
          if [ -d /usr/local/share/chromium ]; then echo "Removing chromium..."; start=$(date +%s); sudo rm -rf /usr/local/share/chromium; end=$(date +%s); echo "Duration: $((end-start))s"; fi
      - name: Show disk space after cleanup
        run: |
          echo 'Disk space after cleanup:'
          df -h
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          repository: ${{ env.REFERENCE_INTEGRATION_REPO }}
          ref: ${{ inputs.target_branch || 'main' }}
          token: ${{ secrets.REPO_READ_TOKEN != '' && secrets.REPO_READ_TOKEN || github.token }}
      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.15.0
        with:
          # Avoid downloading Bazel every time.
          bazelisk-cache: true
          # Store build cache per workflow.
          disk-cache: ${{ github.workflow }}
          # Share repository cache between workflows.
          repository-cache: true
      - name: Update known good commits
        run: |
          echo "::group::write known_good.json from input"
          # write the known_good.json from input
          cat > known_good.updated.json <<'EOF'
          ${{ inputs.known_good }}
          EOF
          cat known_good.updated.json
          echo "::endgroup::"
          
          echo "::group::update score_modules.MODULE.bazel"
          python3 tools/update_module_from_known_good.py --known known_good.updated.json
          cat score_modules.MODULE.bazel
          echo "::endgroup::"
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_READ_TOKEN != '' && secrets.REPO_READ_TOKEN || github.token }}
      - name: Bazel build targets
        run: |
          CONFIG="${{ inputs.config }}" scripts/integration_test.sh --known-good known_good.updated.json
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_READ_TOKEN != '' && secrets.REPO_READ_TOKEN || github.token }}
      - name: Show disk space after build
        if: always()
        run: |
          echo 'Disk space after build:'
          df -h
      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bazel-build-logs-${{ inputs.config }}
          path: _logs/
          if-no-files-found: warn
          retention-days: 14
